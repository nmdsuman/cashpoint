<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashPoint - মোবাইল ব্যাংকিং</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f2f5;
        }
        .bg-cashpoint-pink {
            background-color: #E2136E;
        }
        .text-cashpoint-pink {
            color: #E2136E;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #FF69B4, #E2136E);
        }
        .sidebar {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .balance-container {
            position: relative;
        }
        .balance-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
        }
        .balance-overlay.show {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body class="bg-gray-100 antialiased">

    <div id="app" class="flex flex-col h-screen max-w-sm mx-auto bg-white shadow-lg overflow-hidden">
        
        <header class="gradient-bg text-white p-4 flex items-center justify-between">
            <h1 id="page-title" class="text-xl font-bold"></h1>
            <button id="menu-btn" class="text-white focus:outline-none">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </header>

        <main id="app-content" class="flex-grow overflow-y-auto p-4 relative"></main>

        <nav id="nav-bar" class="bg-white border-t border-gray-200 shadow-md p-2 flex justify-around items-center">
            <button id="home-btn" class="flex flex-col items-center text-cashpoint-pink font-medium">
                <i class="fas fa-home text-lg"></i>
                <span class="text-xs mt-1">হোম</span>
            </button>
            </nav>

        <aside id="menu-sidebar" class="sidebar fixed top-0 right-0 h-full w-64 bg-white shadow-xl z-50 p-6 flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <span class="text-lg font-bold">মেনু</span>
                <button id="close-menu-btn" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <ul class="space-y-4">
                <li id="home-btn-menu" class="p-3 flex items-center space-x-4 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors">
                    <i class="fas fa-home text-xl text-cashpoint-pink"></i>
                    <span class="text-gray-700 font-medium">হোম</span>
                </li>
                <li id="statement-btn-menu" class="p-3 flex items-center space-x-4 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors">
                    <i class="fas fa-file-invoice text-xl text-cashpoint-pink"></i>
                    <span class="text-gray-700 font-medium">স্টেটমেন্ট</span>
                </li>
                <li id="tournament-btn-menu" class="p-3 flex items-center space-x-4 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors">
                    <i class="fas fa-gamepad text-xl text-cashpoint-pink"></i>
                    <span class="text-gray-700 font-medium">টুর্নামেন্ট</span>
                </li>
                <li id="pin-setup-menu-btn" class="p-3 flex items-center space-x-4 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors">
                    <i class="fas fa-key text-xl text-cashpoint-pink"></i>
                    <span class="text-gray-700 font-medium">পিন সেটআপ</span>
                </li>
                <li id="update-info-btn" class="p-3 flex items-center space-x-4 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors">
                    <i class="fas fa-user-edit text-xl text-cashpoint-pink"></i>
                    <span class="text-gray-700 font-medium">প্রোফাইল আপডেট</span>
                </li>
                <li id="admin-settings-menu-btn" class="p-3 flex items-center space-x-4 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors hidden">
                    <i class="fas fa-cog text-xl text-cashpoint-pink"></i>
                    <span class="text-gray-700 font-medium">অ্যাডমিন প্যানেল</span>
                </li>
            </ul>
            <div class="mt-auto pt-4 border-t border-gray-200">
                <button id="logout-btn" class="w-full text-left p-3 flex items-center space-x-4 rounded-xl cursor-pointer text-red-500 hover:bg-red-50 transition-colors">
                    <i class="fas fa-sign-out-alt text-xl"></i>
                    <span class="font-medium">লগআউট</span>
                </button>
            </div>
        </aside>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase Config and App Initialization
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        const appId = firebaseConfig.appId;
        const pageTitle = document.getElementById('page-title');
        const appContent = document.getElementById('app-content');
        const menuSidebar = document.getElementById('menu-sidebar');
        const menuBtn = document.getElementById('menu-btn');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const homeBtn = document.getElementById('home-btn');
        const homeBtnMenu = document.getElementById('home-btn-menu');
        const statementBtnMenu = document.getElementById('statement-btn-menu');
        const pinSetupMenuBtn = document.getElementById('pin-setup-menu-btn');
        const updateInfoBtn = document.getElementById('update-info-btn');
        const adminSettingsMenuBtn = document.getElementById('admin-settings-menu-btn');
        
        // নতুন টুর্নামেন্ট মেনু বাটন
        const tournamentBtnMenu = document.getElementById('tournament-btn-menu');

        let userProfile = null;
        let isAdmin = false;

        // Routing Functions
        const pages = {
            '/': 'home.html',
            '/statement': 'statement.html',
            '/add-money': 'addMoney.html',
            '/send-money': 'sendMoney.html',
            '/pin-setup': 'pinSetup.html',
            '/update-profile': 'updateProfile.html',
            '/admin': 'admin.html',
        };

        const navigateTo = (path) => {
            history.pushState(null, '', path);
            loadPageContent(path);
        };

        window.onpopstate = () => {
            loadPageContent(location.pathname);
        };

        const loadPageContent = async (path) => {
            const pageFile = pages[path] || pages['/'];
            try {
                const response = await fetch(pageFile);
                const html = await response.text();
                appContent.innerHTML = html;
                pageTitle.textContent = getTitleFromPath(path);
                
                // If it's the home page, load user data
                if (path === '/') {
                    loadUserData();
                }
            } catch (error) {
                console.error("Failed to load page:", error);
            }
        };

        const getTitleFromPath = (path) => {
            switch (path) {
                case '/': return 'হোম';
                case '/statement': return 'স্টেটমেন্ট';
                case '/add-money': return 'অ্যাড মানি';
                case '/send-money': return 'সেন্ড মানি';
                case '/pin-setup': return 'পিন সেটআপ';
                case '/update-profile': return 'প্রোফাইল আপডেট';
                case '/admin': return 'অ্যাডমিন প্যানেল';
                default: return 'CashPoint';
            }
        };

        // User Data Loading
        const loadUserData = () => {
            const userId = auth.currentUser.uid;
            const userDocRef = doc(db, `artifacts/${appId}/users`, userId);
            
            onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    userProfile = doc.data();
                    isAdmin = userProfile.isAdmin || false;
                    
                    const balanceEl = document.getElementById('user-balance');
                    if (balanceEl) {
                        balanceEl.textContent = `৳ ${userProfile.balance}`;
                    }
                    
                    const nameEl = document.getElementById('user-name');
                    if (nameEl) {
                        nameEl.textContent = userProfile.name;
                    }
                    
                    if (isAdmin) {
                        adminSettingsMenuBtn.classList.remove('hidden');
                    } else {
                        adminSettingsMenuBtn.classList.add('hidden');
                    }
                } else {
                    console.log("No user data found!");
                }
            });
        };

        // Firebase Auth State Observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (location.pathname === '/login' || location.pathname === '/register') {
                    navigateTo('/');
                } else {
                    loadPageContent(location.pathname);
                }
            } else {
                if (location.pathname !== '/login' && location.pathname !== '/register') {
                    navigateTo('/login');
                }
            }
        });

        // Event Handlers
        const handleMenuClick = () => {
            menuSidebar.classList.add('open');
        };

        const handleCloseMenu = () => {
            menuSidebar.classList.remove('open');
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Firebase Auth initialization failed:", error);
            }
        };

        logoutBtn.addEventListener('click', async () => {
            await handleLogout();
            navigateTo('/login');
        });
        
        menuBtn.addEventListener('click', handleMenuClick);
        closeMenuBtn.addEventListener('click', handleCloseMenu);
        
        updateInfoBtn.addEventListener('click', () => {
            navigateTo('/update-profile');
            menuSidebar.classList.remove('open');
        });
        
        adminSettingsMenuBtn.addEventListener('click', () => {
            if (isAdmin) {
                navigateTo('/admin');
                menuSidebar.classList.remove('open');
            }
        });
        
        pinSetupMenuBtn.addEventListener('click', () => {
            navigateTo('/pin-setup');
            menuSidebar.classList.remove('open');
        });

        if (homeBtn) {
            homeBtn.addEventListener('click', () => navigateTo('/'));
        }
        if (homeBtnMenu) {
            homeBtnMenu.addEventListener('click', () => {
                navigateTo('/');
                menuSidebar.classList.remove('open');
            });
        }
        if (statementBtnMenu) {
            statementBtnMenu.addEventListener('click', () => {
                navigateTo('/statement');
                menuSidebar.classList.remove('open');
            });
        }
        // টুর্নামেন্ট বাটন এর ইভেন্ট হ্যান্ডলার
        if (tournamentBtnMenu) {
            tournamentBtnMenu.addEventListener('click', () => {
                window.location.href = '/turnament';
            });
        }
    </script>
</body>
</html>